version: '3.8'

services:
  # ========================================================================
  # Server: Flask + SocketIO chat backend
  # ========================================================================
  server:
    build:
      context: .
      dockerfile: Dockerfile
      target: server
    container_name: bot-swarm-server
    ports:
      - "${SERVER_PORT:-5000}:5000"
    volumes:
      - ./emotes:/app/emotes
      - ./static:/app/static
      - ./templates:/app/templates
    environment:
      - PYTHONUNBUFFERED=1
      - FLASK_ENV=production
      - PORT=5000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    networks:
      - bot-network

  # ========================================================================
  # Bot Swarm: Multiple personality bots that connect to server
  # ========================================================================
  bot_swarm:
    build:
      context: .
      dockerfile: Dockerfile
      target: swarm
    container_name: bot-swarm-bots
    depends_on:
      server:
        condition: service_healthy
    environment:
      - PYTHONUNBUFFERED=1
      - SERVER_URL=http://server:5000
      - LM_API=${LM_API:-http://localhost:1234/v1/chat/completions}
      - MODEL=${LM_MODEL:-lmstudio-community/Meta-Llama-3-8B-Instruct}
      - NUM_BOTS=${NUM_BOTS:-12}
      - MAX_TOKENS=${MAX_TOKENS:-60}
      - TEMPERATURE=${TEMPERATURE:-0.85}
      - ROOM_ID=${ROOM_ID:-test-room-123}
    restart: unless-stopped
    networks:
      - bot-network

networks:
  bot-network:
    driver: bridge